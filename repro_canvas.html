<!DOCTYPE html>
<html>

<head>
    <title>Canvas Repro</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        .test-case {
            margin-bottom: 20px;
            border: 1px solid #ccc;
            padding: 10px;
        }

        canvas {
            border: 1px solid red;
        }
    </style>
</head>

<body>
    <h1>Canvas Logic Repro</h1>
    <div id="results"></div>

    <script>
        const SIZE = 128;

        function runTest(name, imgWidth, imgHeight, mode) {
            const container = document.createElement('div');
            container.className = 'test-case';
            container.innerHTML = `<h3>${name} (${imgWidth}x${imgHeight}, ${mode})</h3>`;

            // Create a dummy image
            const imgCanvas = document.createElement('canvas');
            imgCanvas.width = imgWidth;
            imgCanvas.height = imgHeight;
            const imgCtx = imgCanvas.getContext('2d');

            // Draw a pattern so we can see alignment
            imgCtx.fillStyle = '#eee';
            imgCtx.fillRect(0, 0, imgWidth, imgHeight);
            imgCtx.fillStyle = 'blue';
            imgCtx.fillRect(0, 0, imgWidth / 2, imgHeight / 2); // Top-left blue
            imgCtx.fillStyle = 'green';
            imgCtx.fillRect(imgWidth / 2, imgHeight / 2, imgWidth / 2, imgHeight / 2); // Bottom-right green
            imgCtx.fillStyle = 'red';
            imgCtx.beginPath();
            imgCtx.arc(imgWidth / 2, imgHeight / 2, Math.min(imgWidth, imgHeight) / 4, 0, Math.PI * 2);
            imgCtx.fill(); // Center red circle

            const img = new Image();
            img.src = imgCanvas.toDataURL();

            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = SIZE;
                canvas.height = SIZE;
                const ctx = canvas.getContext('2d');

                // --- THE SUSPECT LOGIC START ---
                const aspect = img.width / img.height;
                let dx = 0, dy = 0, dw = SIZE, dh = SIZE;

                if (mode === 'contain') {
                    if (aspect > 1) { // Wider
                        dh = SIZE / aspect;
                        dy = (SIZE - dh) / 2;
                    } else {
                        dw = SIZE * aspect;
                        dx = (SIZE - dw) / 2;
                    }
                } else if (mode === 'cover') {
                    if (aspect > 1) { // Wider - crop sides
                        dw = SIZE * aspect;
                        dx = (SIZE - dw) / 2;
                    } else {
                        dh = SIZE / aspect;
                        dy = (SIZE - dh) / 2;
                    }
                }
                // --- THE SUSPECT LOGIC END ---

                ctx.drawImage(img, dx, dy, dw, dh);

                container.appendChild(canvas);

                const info = document.createElement('div');
                info.innerHTML = `
                    Aspect: ${aspect.toFixed(2)}<br>
                    dx: ${dx.toFixed(2)}, dy: ${dy.toFixed(2)}<br>
                    dw: ${dw.toFixed(2)}, dh: ${dh.toFixed(2)}
                `;
                container.appendChild(info);
            };

            document.getElementById('results').appendChild(container);
        }

        // Test cases
        runTest('Square', 100, 100, 'cover');
        runTest('Wide (2:1)', 200, 100, 'cover');
        runTest('Tall (1:2)', 100, 200, 'cover');

        runTest('Wide (2:1)', 200, 100, 'contain');
        runTest('Tall (1:2)', 100, 200, 'contain');

        // --- SOLUTION 2 TESTS ---
        function runTestSol2(name, imgWidth, imgHeight) {
            const container = document.createElement('div');
            container.className = 'test-case';
            container.innerHTML = `<h3>${name} (Solution 2)</h3>`;

            const imgCanvas = document.createElement('canvas');
            imgCanvas.width = imgWidth;
            imgCanvas.height = imgHeight;
            const imgCtx = imgCanvas.getContext('2d');
            imgCtx.fillStyle = '#eee';
            imgCtx.fillRect(0, 0, imgWidth, imgHeight);
            imgCtx.fillStyle = 'blue';
            imgCtx.fillRect(0, 0, imgWidth / 2, imgHeight / 2);
            imgCtx.fillStyle = 'green';
            imgCtx.fillRect(imgWidth / 2, imgHeight / 2, imgWidth / 2, imgHeight / 2);
            imgCtx.fillStyle = 'red';
            imgCtx.beginPath();
            imgCtx.arc(imgWidth / 2, imgHeight / 2, Math.min(imgWidth, imgHeight) / 4, 0, Math.PI * 2);
            imgCtx.fill();

            const img = new Image();
            img.src = imgCanvas.toDataURL();

            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = SIZE;
                canvas.height = SIZE;
                const ctx = canvas.getContext('2d');

                // --- SOLUTION 2 LOGIC ---
                const scale = Math.max(SIZE / img.width, SIZE / img.height);
                const scaledWidth = img.width * scale;
                const scaledHeight = img.height * scale;
                const dx = (SIZE - scaledWidth) / 2;
                const dy = (SIZE - scaledHeight) / 2;
                const dw = scaledWidth;
                const dh = scaledHeight;
                // ------------------------

                ctx.drawImage(img, dx, dy, dw, dh);
                container.appendChild(canvas);

                const info = document.createElement('div');
                info.innerHTML = `
                    scale: ${scale.toFixed(2)}<br>
                    dx: ${dx.toFixed(2)}, dy: ${dy.toFixed(2)}<br>
                    dw: ${dw.toFixed(2)}, dh: ${dh.toFixed(2)}
                `;
                container.appendChild(info);
            };
            document.getElementById('results').appendChild(container);
        }

        runTestSol2('Square', 100, 100);
        runTestSol2('Wide (2:1)', 200, 100);
        runTestSol2('Tall (1:2)', 100, 200);

    </script>
</body>

</html>